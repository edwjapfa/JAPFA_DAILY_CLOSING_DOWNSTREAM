WITH GI AS (
	SELECT
        SOURCE_SYSTEM,
        --FISCAL_YEAR,
        COMPANY_CODE,
        --MATERIAL_DOCUMENT_YEAR,
        PURCHASE_ORDER,
        MATERIAL,
        PLANT              AS SENDER_PLANT,
        RECEIVING_PLANT    AS RECEIVER_PLANT,
        MIN(POSTING_DATE) AS POSTING_DATE_MIN,
        MAX(POSTING_DATE) AS POSTING_DATE_MAX,
        SUM(SIGNED_QUANTITY_FOR_BALANCE) AS QTY_641_642
    FROM F_SCM_STOCK_TRANSACTION_SAP 
    WHERE MOVEMENT_TYPE IN ('641','351', '642', '352') -->PE2 using 641 and 351 for PO STO, 642 dan 352 adalah reverse nya
      AND MATERIAL_DOCUMENT_NUMBER IS NOT NULL
      AND ITEM_AUTOMATICALLY_CREATED IS NULL
      AND PURCHASE_ORDER IS NOT NULL
      AND SOURCE_SYSTEM = 'PE2'
    GROUP BY ALL
    HAVING SUM(SIGNED_QUANTITY_FOR_BALANCE) <>0
    
    UNION ALL
    
    SELECT
        SOURCE_SYSTEM,
        --FISCAL_YEAR,
        COMPANY_CODE,
        --MATERIAL_DOCUMENT_YEAR,
        PURCHASE_ORDER,
        MATERIAL,
        PLANT              AS SENDER_PLANT,
        RECEIVING_PLANT    AS RECEIVER_PLANT,
        MIN(POSTING_DATE) AS POSTING_DATE_MIN,
        MAX(POSTING_DATE) AS POSTING_DATE_MAX,
        SUM(SIGNED_QUANTITY_FOR_BALANCE) AS QTY_641_642
    FROM F_SCM_STOCK_TRANSACTION_SAP 
    WHERE MOVEMENT_TYPE IN ('641', '642') -->PE1 hanya pakai 641 untuk PO STO, 642 adalah reverse nya
      AND MATERIAL_DOCUMENT_NUMBER IS NOT NULL
      AND ITEM_AUTOMATICALLY_CREATED IS NULL
      AND PURCHASE_ORDER IS NOT NULL
      AND SOURCE_SYSTEM = 'PE1'
    GROUP BY ALL
    HAVING SUM(SIGNED_QUANTITY_FOR_BALANCE) <>0
),
GR AS (
SELECT
    SOURCE_SYSTEM,
    --FISCAL_YEAR,
    COMPANY_CODE,
    --MATERIAL_DOCUMENT_YEAR,
    PURCHASE_ORDER,
    MATERIAL,
    PLANT AS RECEIVER_PLANT,
    MIN(POSTING_DATE) AS POSTING_DATE_MIN,
    MAX(POSTING_DATE) AS POSTING_DATE_MAX,
    SUM(SIGNED_QUANTITY_FOR_BALANCE) AS QTY_101_102
FROM F_SCM_STOCK_TRANSACTION_SAP
WHERE MOVEMENT_TYPE IN ('101', '102')
  AND MATERIAL_DOCUMENT_NUMBER IS NOT NULL
  AND ITEM_AUTOMATICALLY_CREATED IS NULL
  AND PURCHASE_ORDER IS NOT NULL
  /*AND SOURCE_SYSTEM = 'PE2'*/ --for PE1 dan PE2 kodenya sama 101 dan 102 untuk cancel nya
GROUP BY ALL
HAVING SUM(SIGNED_QUANTITY_FOR_BALANCE) <> 0
), 
adj_loss_gain AS (
    SELECT
        SOURCE_SYSTEM,
        --FISCAL_YEAR,
        COMPANY_CODE,
        --MATERIAL_DOCUMENT_YEAR,
        PURCHASE_ORDER,
        MATERIAL,
        PLANT,
        RECEIVING_PLANT,
        SUM(SIGNED_QUANTITY_FOR_BALANCE) AS QTY_LOSS_GAIN
    FROM F_SCM_STOCK_TRANSACTION_SAP
    WHERE MOVEMENT_TYPE IN ('Z01', 'Z19')
      AND ITEM_AUTOMATICALLY_CREATED IS NULL
      AND PURCHASE_ORDER IS NOT NULL
      AND SOURCE_SYSTEM = 'PE2'
    GROUP BY ALL
    
    UNION ALL
    
	SELECT
        SOURCE_SYSTEM,
        --FISCAL_YEAR,
        COMPANY_CODE,
        --MATERIAL_DOCUMENT_YEAR,
        PURCHASE_ORDER,
        MATERIAL,
        PLANT,
        RECEIVING_PLANT,
        SUM(SIGNED_QUANTITY_FOR_BALANCE) AS QTY_LOSS_GAIN
    FROM F_SCM_STOCK_TRANSACTION_SAP
    WHERE MOVEMENT_TYPE IN ('701')
      AND ITEM_AUTOMATICALLY_CREATED IS NULL
      AND PURCHASE_ORDER IS NOT NULL
      AND SOURCE_SYSTEM = 'PE1'
    GROUP BY ALL
), aggr AS (
SELECT
    S.SOURCE_SYSTEM,
    --S.FISCAL_YEAR,
    S.COMPANY_CODE,
    --S.MATERIAL_DOCUMENT_YEAR,
    S.PURCHASE_ORDER,
    S.MATERIAL,
    mm.MATERIAL_DESC ,
    s.SENDER_PLANT,
    mp.PLANT_NAME AS SENDER_PLANT_NAME,
    S.RECEIVER_PLANT,
    mr.PLANT_NAME AS RECEIVER_PLANT_NAME,
    S.POSTING_DATE_MIN AS SENDER_POSTING_DATE_MIN, 
    S.POSTING_DATE_MAX AS SENDER_POSTING_DATE_MAX,
    R.POSTING_DATE_MIN AS RECEIVER_POSTING_DATE_MIN,
    R.POSTING_DATE_MAX AS RECEIVER_POSTING_DATE_MAX,
    s.QTY_641_642 AS QTY_GI,
    COALESCE(r.QTY_101_102,0) AS QTY_GR,
    sum(s.QTY_641_642 + r.QTY_101_102) AS QTY_DIFF,
    sum(COALESCE(QTY_LOSS_GAIN,0)) AS QTY_LOSS_GAIN,
    CASE
        WHEN SUM(COALESCE(R.QTY_101_102, 0)) = 0
             AND COUNT(R.QTY_101_102) = 0
            THEN 'Not Yet Delivered'
        WHEN SUM(S.QTY_641_642 + COALESCE(R.QTY_101_102, 0)) <> 0
            THEN 'SELISIH'
        ELSE 'MATCH'
    END AS KETERANGAN
FROM GI s 
LEFT JOIN GR r
    ON  s.SOURCE_SYSTEM           = r.SOURCE_SYSTEM
    AND s.COMPANY_CODE            = r.COMPANY_CODE
    AND s.PURCHASE_ORDER          = r.PURCHASE_ORDER
    AND s.MATERIAL                = r.MATERIAL
    AND s.RECEIVER_PLANT 		  = r.RECEIVER_PLANT
LEFT JOIN adj_loss_gain lg 
	ON  s.SOURCE_SYSTEM           = lg.SOURCE_SYSTEM
    AND s.COMPANY_CODE            = lg.COMPANY_CODE
    AND s.PURCHASE_ORDER          = lg.PURCHASE_ORDER
    AND s.MATERIAL                = lg.MATERIAL
    AND s.RECEIVER_PLANT 		  = lg.PLANT
LEFT JOIN D_SCM_MATERIAL mm
	ON s.MATERIAL = mm.MATERIAL AND s.SOURCE_SYSTEM = mm.SOURCE_SYSTEM 
LEFT JOIN D_SCM_PLANT mp
	ON s.SENDER_PLANT = mp.PLANT AND s.SOURCE_SYSTEM = mp.SOURCE_SYSTEM 
LEFT JOIN D_SCM_PLANT mr
	ON s.RECEIVER_PLANT = mr.PLANT AND s.SOURCE_SYSTEM = mp.SOURCE_SYSTEM 
GROUP BY ALL )
SELECT * FROM AGGR
    ;
